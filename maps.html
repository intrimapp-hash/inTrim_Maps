<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pick Location</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.0/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.0/dist/leaflet.js"></script>
</head>
<body style="margin:0;">
  <div id="map" style="width:100%; height:100vh;"></div>

  <script>
    // Initialize the map (will be set dynamically based on location)
    const map = L.map('map').setView([37.7749, -122.4194], 13); // Default to San Francisco
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker; // To store the marker

    // Function to fetch the user's current location
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // Set the map's view to the user's current location
          map.setView([lat, lon], 13);

          // Add a marker at the user's location
          if (!marker) {
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
          } else {
            marker.setLatLng([lat, lon]);
          }

          // Get the address of the current location
          getAddress(lat, lon);
        }, (error) => {
          console.error("Error getting location: ", error);
          // Default location if geolocation fails
          const defaultLat = 37.7749;
          const defaultLon = -122.4194;
          map.setView([defaultLat, defaultLon], 13);
          if (marker) marker.setLatLng([defaultLat, defaultLon]);
        });
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
    }

    // Reverse geocoding function to get the address
    async function getAddress(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=en`;

      // Fetch address from Nominatim API
      const response = await fetch(url, { headers: { 'User-Agent': 'your-app-name' } }); // Replace with your app name
      const data = await response.json();
      const address = data.display_name || "No address found";

      // Send data (lat, lng, address) back to Flutter (via WebView)
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onLocationSelected', {
          lat: lat,
          lng: lon,
          address: address
        });
      }

      // Optionally show the address on the page (for testing)
      alert(address);
    }

    // Call the function to get current location when the page loads
    getCurrentLocation();

    // When the user drags the marker, update the address
    map.on('moveend', async function() {
      const lat = marker.getLatLng().lat;
      const lon = marker.getLatLng().lng;
      getAddress(lat, lon);
    });

    // When the map is clicked, place a marker and get the address
    map.on('click', async function(e) {
      // Remove previous marker (if any)
      if (marker) map.removeLayer(marker);

      // Add a new marker at clicked location (draggable)
      marker = L.marker(e.latlng, { draggable: true }).addTo(map);

      // Get the address from Nominatim
      getAddress(e.latlng.lat, e.latlng.lng);
    });

  </script>
</body>
</html>
