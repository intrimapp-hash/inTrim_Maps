<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pick Location</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.0/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.0/dist/leaflet.js"></script>
</head>
<body style="margin:0;">
  <div id="map" style="width:100%; height:100vh;"></div>

  <script>
    const map = L.map('map').setView([37.7749, -122.4194], 13); // Default location
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker; // To store the marker

    // Function to fetch address and update marker popup
    async function getAddress(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=en`;

      const response = await fetch(url, { headers: { 'User-Agent': 'your-app-name' } });
      const data = await response.json();
      const address = data.display_name || "No address found";

      // Update marker popup
      if (marker) {
        marker.bindPopup(address).openPopup();
      }

      // Send data back to Flutter
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onLocationSelected', {
          lat: lat,
          lng: lon,
          address: address
        });
      }
    }

    // Get user's current location
    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          map.setView([lat, lon], 13);

          // Add draggable marker at current location
          if (!marker) {
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
            marker.on('dragend', function(e) {
              const latLng = e.target.getLatLng();
              getAddress(latLng.lat, latLng.lng);
            });
          } else {
            marker.setLatLng([lat, lon]);
          }

          getAddress(lat, lon);
        }, () => {
          console.error("Unable to get location. Using default.");
        });
      }
    }

    getCurrentLocation();

    // Click on map to place new draggable marker
    map.on('click', function(e) {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng, { draggable: true }).addTo(map);

      // Update address when dragging
      marker.on('dragend', function(ev) {
        const latLng = ev.target.getLatLng();
        getAddress(latLng.lat, latLng.lng);
      });

      getAddress(e.latlng.lat, e.latlng.lng);
    });
  </script>
</body>
</html>
